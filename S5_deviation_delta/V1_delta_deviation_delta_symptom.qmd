---
title: "S1_delta_deviation_delta_symptom"
author:
  - name: Xiaoyu Xu
    orcid: 0000-0002-7349-3366
    email: xuxiaoyu@cibr.ac.cn
    url: https://scholar.google.com/citations?user=G0jeI1AAAAAJl
    affiliation: 
      - name: Chinese Institute for Brain Research, Beijing (CIBR)
        group: CUIZAIXU Lab
        url: https://cuilab.cibr.ac.cn/
date: "2025-06-09"
format: 
  html:
    code-fold: true
    code-tools: true
    theme: Materia
    toc: true
    toc_depth: 3
    toc-expand: 1
    toc_float: true
    toc-location: left
    number-sections: true
    number-depth: 3
    embed-resources: true
---

This script is to test whether the SC deviation change associated with symtom change.

```{r}
#| label: load-packages-data
#| include: false
rm(list=ls())
library(ggplot2)
library(RColorBrewer)
library(tidyverse)
library(mgcv)
library(ppcor)
library(openxlsx)
library(parallel)
library(ecostats)
library(psych)
library(reshape)
library(tableone)
library(chorddiag)
library(circlize)
# set resolution
Yeoresolution <- 17
if (Yeoresolution == 7){
  Yeoresolution.delLM = 6
}else if (Yeoresolution == 17){
  Yeoresolution.delLM = 15
}
element_num <- Yeoresolution.delLM*(Yeoresolution.delLM+1)/2
# input directory
wd <- getwd()
homepath <- str_split_i(wd, "Normative_model", 1)
demopath <- paste0(homepath, '/Normative_model/demography')
interfileFolder <- paste0(homepath, '/Normative_model/interfileFolder_ABCD')
functionFolder <- paste0(homepath, "/Normative_model/functions")
resultFolder <- paste0(homepath, "/Normative_model/results_ABCD")
functionFolder.SCDev <- paste0(homepath, "/SC_development/Rcode_SCdevelopment/gamfunction")
FigureFolder <- paste0(homepath, '/Normative_model/Figures_ABCD/Yeo', Yeoresolution,'/CV75')
source(paste0(functionFolder.SCDev, "/SCrankcorr.R"))
source(paste0(functionFolder.SCDev, "/gammsmooth.R"))
source(paste0(functionFolder.SCDev, "/plotdata_generate.R"))
source(paste0(functionFolder, "/lmsymp.R"))
source(paste0(functionFolder, "/plotmatrix.R"))
# Load data
SCdata.sum75.merge.ADHDTD <- readRDS(paste0(interfileFolder, '/SCdata_Yeo',Yeoresolution, '_CV75_sumSCinvnode.deviations_TDtest_ADHD.rds'))
SCdata.sum75.merge.ADHDTD$sex <- as.factor(SCdata.sum75.merge.ADHDTD$sex)
SCdata.sum75.merge.ADHDTD$meanFD <- as.numeric(SCdata.sum75.merge.ADHDTD$meanFD)
SCdata.sum75.merge.ADHDTD$if_TD <- factor(SCdata.sum75.merge.ADHDTD$if_TD, levels = c("TD", "ADHD"))
SCdata.sum75.merge.ADHDTD$agefactor <- (SCdata.sum75.merge.ADHDTD$age < 10.3)
SCdata.sum75.merge.ADHDTD$agefactor <- factor(SCdata.sum75.merge.ADHDTD$agefactor, levels = c(T, F), labels=c("young", "old"))
Behavior <- read.csv(paste0(demopath, "/demo_sublist7.csv"))
#SCdata.sum75.merge.ADHDTD <- SCdata.sum75.merge.ADHDTD %>% left_join(select(Behavior, scanID, GENERAL.norm, EXT.norm, ADHD.norm, INT.norm, ATT.norm, HI.norm), by="scanID")
SCdata.ADHD <- SCdata.sum75.merge.ADHDTD %>% filter(if_TD=="ADHD")
SCdata.TD <- SCdata.sum75.merge.ADHDTD %>% filter(if_TD=="TD")

SCdata.ADHDTD.l <- SCdata.sum75.merge.ADHDTD %>% group_by(subID) %>% filter(n()>1)
SCdata.ADHDTD.l$eventname <- factor(SCdata.ADHDTD.l$eventname, levels = c("baseline_year_1_arm_1", "2_year_follow_up_y_arm_1", "4_year_follow_up_y_arm_1"))
table(SCdata.ADHDTD.l$if_TD, SCdata.ADHDTD.l$eventname)
SCdata.ADHD.l <- SCdata.ADHDTD.l %>% filter(if_TD=="ADHD")

Intresults <- readRDS(paste0(interfileFolder, "/Interaction_Age_TD-ADHDall_Yeo_SC", element_num,".rds"))
Int.results.df_final <- Intresults[seq(from=2, to=2*element_num, by = 2),]
Int.results.df_final$bootstrap_pvalue.fdr <- p.adjust(Int.results.df_final$bootstrap_pvalue, method = "fdr")
Int.results.df_final$bootstrap.P.disease.fdr <- p.adjust(Int.results.df_final$bootstrap.P.disease, method = "fdr")
Int.results.df_final[,3:10] <- lapply(Int.results.df_final[,3:10], as.numeric)
summary(Int.results.df_final)

diagnosis.rs.8_10 <- readRDS(paste0(interfileFolder, "/GroupcompareDeviation_TD-ADHDall_SC_Yeo", element_num, "_8_10_controlAgeSex.rds"))
diffbyage <- read.csv(paste0(resultFolder, "/ADHDTDgroupwise_T_dev_by_age_SC_Yeo", element_num,"_CV75_controlsex.csv"))
sigedge.8_10 <- diagnosis.rs.8_10$parcel[diagnosis.rs.8_10$p.fdr < 0.05]
sigedge.all <- diffbyage$parcel

```

## Step1 Compute the deviation delta of ADHD participants.

Pair definition: baseline - 2year-FU; 2year-FU - 4year-FU

```{r}
#| label: Step1

symptomvar <- c("GENERAL.norm", "EXT.norm", "ADHD.norm", "INT.norm", "ATT.norm", "HI.norm", "cbcl_scr_syn_internal_t", "cbcl_scr_syn_external_t", "cbcl_scr_dsm5_adhd_t", "cbcl_scr_syn_attention_t", "cbcl_scr_syn_totprob_t")
SCdata.ADHDTD.l$visit <- factor(SCdata.ADHDTD.l$eventname, levels = c("baseline_year_1_arm_1", "2_year_follow_up_y_arm_1", "4_year_follow_up_y_arm_1"), labels=c(1, 2, 3))
# compute difference
SCdata.ADHDTD.l.delta <- SCdata.ADHDTD.l %>% select(subID, visit, age, sex, meanFD, if_TD, all_of(symptomvar), matches("^SC.*deviationZ$")) %>%
  group_by(subID) %>% dplyr::arrange(visit, .by_group = T) %>%
  mutate(across(c(matches("^SC.*deviationZ$"), "age", symptomvar), 
                list(diff_2_b = ~ifelse(visit == 2, . - .[visit == 1], NA),
                  diff_4_2 = ~ifelse(visit == 3, . - .[visit == 2], NA),
                  diff_4_b = ~ifelse(visit == 3, . - .[visit == 1], NA)), 
                .names = "{.col}_{.fn}"),
         sex = unique(sex),
         across(c("age", "meanFD"), 
                list(mean_2_b = ~ifelse(visit == 2, (. + .[visit == 1])/2, NA),
                  mean_4_2 = ~ifelse(visit == 3, (. + .[visit == 2])/2, NA),
                  mean_4_b = ~ifelse(visit == 3, (. + .[visit == 1])/2, NA)), 
                .names = "{.col}_{.fn}")
         ) %>%
  select(-c(matches("^SC.*deviationZ$"), all_of(symptomvar))) %>% 
  filter(visit %in% c(2,3)) %>% 
  fill(starts_with("SC_"), .direction = "downup") %>% 
  select(-visit)

# compute difference scaled by age gap
SCdata.ADHDTD.l.delta <- SCdata.ADHDTD.l.delta %>% 
  mutate(across(matches("*_diff_2_b$"), list(delta_2b = ~ifelse(!is.na(.), . / age_diff_2_b, NA)), .names = "{.col}_{.fn}"),
         across(matches("*_diff_4_2$"), list(delta_42 = ~ifelse(!is.na(.), . / age_diff_4_2, NA)), .names = "{.col}_{.fn}"),
         across(matches("*_diff_4_b$"), list(delta_4b = ~ifelse(!is.na(.), . / age_diff_4_b, NA)), .names = "{.col}_{.fn}")
         ) %>% select(contains("delta"), contains("age"), subID, contains("mean"), if_TD, sex)

index <- which(str_detect(names(SCdata.ADHDTD.l.delta), "SC."))
names(SCdata.ADHDTD.l.delta)[index] <- paste0(str_split_i(names(SCdata.ADHDTD.l.delta)[index], "_", 1), "_", str_split_i(names(SCdata.ADHDTD.l.delta)[index], "_", 6), "_", str_split_i(names(SCdata.ADHDTD.l.delta)[index], "_", 7))
index2 <- which(str_detect(names(SCdata.ADHDTD.l.delta), "diff") & str_detect(names(SCdata.ADHDTD.l.delta), "delta"))
names(SCdata.ADHDTD.l.delta)[index2] <- gsub("_diff_2_b", "", names(SCdata.ADHDTD.l.delta)[index2])
names(SCdata.ADHDTD.l.delta)[index2] <- gsub("_diff_4_b", "", names(SCdata.ADHDTD.l.delta)[index2])
names(SCdata.ADHDTD.l.delta)[index2] <- gsub("_diff_4_2", "", names(SCdata.ADHDTD.l.delta)[index2])

SCdata.ADHDTD.l.delta.l <- SCdata.ADHDTD.l.delta %>% 
  pivot_longer(
    cols = matches(".+_(delta_2b|delta_42|delta_4b)$"),
    names_to = c("Var", "delta_type"), 
    names_pattern = "(.+)_(delta_.*)",
    values_to = "delta_value"
  ) %>% select(-matches("^age.*delta"))

SCdata.ADHDTD.l.delta.l2 <- SCdata.ADHDTD.l.delta.l %>% 
  pivot_wider(names_from = Var,
              values_from = delta_value,
              names_glue = "{Var}_delta")
SCdata.ADHDTD.l.delta.l2 <- SCdata.ADHDTD.l.delta.l2 %>% drop_na(ends_with("_delta"))

write.csv(SCdata.ADHDTD.l.delta.l2, paste0(interfileFolder, "/Delta_SCDeviation_symptomTscore_ADHD_TD_Yeo", element_num, "_CV75.csv"), row.names = F)
# organize covariates
SCdata.ADHDTD.l.delta.l2 <- SCdata.ADHDTD.l.delta.l2 %>% mutate(
  meanFD.M = case_when(
    delta_type == "delta_2b" ~ meanFD_mean_2_b,
    delta_type == "delta_42" ~ meanFD_mean_4_2,
    delta_type == "delta_4b" ~ meanFD_mean_4_b,
    .default = NA),
  age.M = case_when(
    delta_type == "delta_2b" ~ age_mean_2_b,
    delta_type == "delta_42" ~ age_mean_4_2,
    delta_type == "delta_4b" ~ age_mean_4_b,
    .default = NA)
) %>% select(-c(starts_with("age_"), starts_with("meanFD_")))

deltavars <- names(SCdata.ADHDTD.l.delta.l2)[str_detect(names(SCdata.ADHDTD.l.delta.l2), "_delta")]
describetab <- CreateTableOne(deltavars, strata = "if_TD",data=SCdata.ADHDTD.l.delta.l2, test = TRUE, smd = TRUE)
describetab <- print(describetab, pDigits = 3, test=T)

write.csv(describetab, paste0(resultFolder, "/delta_stats_SC_Yeo", element_num, "_CV75.csv"))
```

## Step2 Correlation analyses for SC.delta and symptom.delta.

Referring to Chiang et al., Asian J Psychiatr, 2023.

```{r}
#| label: Step2

SCdata.ADHDTD.l.delta.l2 <- as.data.frame(SCdata.ADHDTD.l.delta.l2)
SCdata.ADHD.l.delta <- SCdata.ADHDTD.l.delta.l2 %>% filter(if_TD=="ADHD")
dataname <- "SCdata.ADHD.l.delta"

cl <- makeCluster(8)
clusterExport(cl, varlist = ls(), envir = .GlobalEnv)
invisible(clusterEvalQ(cl, {
  library(ggplot2)
  library(RColorBrewer)
  library(tidyverse)
  library(mgcv)
  library(openxlsx)
  library(parallel)
  library(scales)
  library(psych)
  library(reshape)
  source(paste0(functionFolder, "/plotmatrix.R"))
  source(paste0(functionFolder.SCDev, "/SCrankcorr.R"))
  source(paste0(functionFolder.SCDev, "/gammsmooth.R"))
  source(paste0(functionFolder.SCDev, "/plotdata_generate.R"))
  source(paste0(functionFolder, "/lmsymp.R"))
}))

deltacorr <- list()
for (VOI in symptomvar){
  if (! file.exists(paste0(interfileFolder, "/SCDeviationDelta_", VOI,"_CV75SC_Yeo", element_num,"_controlSex.rds"))){
  clusterExport(cl, varlist = ls(), envir = .GlobalEnv)
    
  deltaresultsum <- parLapply(cl, 1:element_num, function(x){
      sympvar.tmp <- paste0(VOI, "_delta")
      SClabel<-paste0("SC.", x, "_delta")
      region<-SClabel
      deltaresult<-lm.fit.symp(region, dataname, sympvar.tmp, covariates="sex")
      
      return(deltaresult)
    })
    
    deltaresult.df <- do.call(rbind, lapply(deltaresultsum, as.data.frame))
    deltaresult.df[,3:8] <- lapply(deltaresult.df[,3:8], as.numeric)
    deltaresult.df$anova.cov.p.fdr <- p.adjust(deltaresult.df$anova.cov.pvalue, method="fdr")
    
    saveRDS(deltaresult.df, paste0(interfileFolder, "/SCDeviationDelta_", VOI,"_CV75SC_Yeo", element_num,"_controlSex.rds"))
  }else{
  deltaresult.df <- readRDS(paste0(interfileFolder, "/SCDeviationDelta_", VOI,"_CV75SC_Yeo", element_num,"_controlSex.rds"))
  
  deltacorr[[VOI]] <- deltaresult.df
}}

Intedge <- Int.results.df_final$parcel[Int.results.df_final$bootstrap_pvalue < 0.05]
Intedge <- gsub("_h", "", Intedge)
SCcorr.df.list <- list()
for (j in 1:length(symptomvar)){
  deltaresult.df <- deltacorr[[j]]
  deltaresult.df$parcel <- gsub("_delta", "", deltaresult.df$parcel)
  symptom.tmp <- deltaresult.df$symp_var[1]
  symptom.tmp <- gsub("_delta", "", symptom.tmp)
  
  numsig <- sum(deltaresult.df$anova.cov.pvalue < 0.05)
  numsig.fdr <- sum(deltaresult.df$anova.cov.p.fdr < 0.05)
  
  print(paste("Before FDR, delta of", numsig, "edges are significantly correlated with", symptom.tmp,"change."))
  print(paste("After FDR, delta of", numsig.fdr, "edges are significantly correlated with", symptom.tmp,"change."))
  
  SCcorr.df <- SCrankcorr(deltaresult.df, "lm.symp.t", Yeoresolution.delLM)
  SCcorr.df$symptom <- symptom.tmp
  SCcorr.df.list[[j]] <- SCcorr.df
  
  # Edges with significant group-wise difference during 8 to 10.
  deltaresult.df.sigdiag <- deltaresult.df %>% filter(parcel %in% Intedge)
  deltaresult.df.sigdiag$anova.cov.p.fdr <- p.adjust(deltaresult.df.sigdiag$anova.cov.pvalue, method = "fdr")
  numsig.fdr2 <- sum(deltaresult.df.sigdiag$anova.cov.p.fdr < 0.05)
  print(paste("Within edges with significant group-wise interaction, after FDR, delta of", numsig.fdr2, "edges are significantly correlated with", symptom.tmp,"change."))
}

SCcorr.df <- do.call(rbind, SCcorr.df.list)
print(SCcorr.df)

```

## Step2.1 Plot

```{r}
#| label: Step2.1
sigedge.8_10 <- gsub("_deviationZ", "", sigedge.8_10)
sigedge.all <- gsub("_deviationZ", "", sigedge.all)
SCcorr.df.list <- list()
axeslabels=c("VS.P", "SM.A", "VS.C", "SM.B", "DA.A", "DA.B", "FP.C", "DM.C", "VA.A", "TP", "FP.A", "VA.B", "DM.A", "FP.B", "DM.B")
for (j in 1:length(symptomvar)){
  deltaresult.df <- deltacorr[[j]]
  deltaresult.df$parcel <- gsub("_delta", "", deltaresult.df$parcel)
  symptom.tmp <- deltaresult.df$symp_var[1]
  symptom.tmp <- gsub("_delta", "", symptom.tmp)
  
  numsig <- sum(deltaresult.df$anova.cov.pvalue < 0.05)
  numsig.fdr <- sum(deltaresult.df$anova.cov.p.fdr < 0.05)
  
  print(paste("Before FDR, delta of", numsig, "edges are significantly correlated with", symptom.tmp,"change."))
  print(paste("After FDR, delta of", numsig.fdr, "edges are significantly correlated with", symptom.tmp,"change."))
  
  SCcorr.df <- SCrankcorr(deltaresult.df, "lm.symp.t", Yeoresolution.delLM)
  SCcorr.df$symptom <- symptom.tmp
  SCcorr.df.list[[j]] <- SCcorr.df
  
  # Edges with significant group-wise difference during 8 to 10.
  deltaresult.df.sigdiag <- deltaresult.df %>% filter(parcel %in% sigedge.all)
  deltaresult.df.sigdiag$anova.cov.p.fdr <- p.adjust(deltaresult.df.sigdiag$anova.cov.pvalue, method = "fdr")
  numsig.fdr2 <- sum(deltaresult.df.sigdiag$anova.cov.p.fdr < 0.05)
  print(paste("Within edges with significant group-wise difference, after FDR, delta of", numsig.fdr2, "edges are significantly correlated with", symptom.tmp,"change."))
  
  # ### plot matrix
  # # all 78 elements
  # lmthr <- max(abs(deltaresult.df$lm.symp.t), na.rm = T)
  # matfig0 <- plotmatrix("deltaresult.df", "lm.symp.t", Yeoresolution.delLM, Pvar="anova.cov.p.fdr", NAcol="white", lmthr=lmthr, axeslabels=axeslabels, axeslabelsGap=T, linerange_frame=NA, PaletteSet=NA, Pvar.noFDR=NA)
  # ggsave(paste0(FigureFolder, "/DeltaSCDeviation_DeltaSymptom/Matrix_SC_", symptom.tmp, "_all_controlSex.tiff"), matfig0, height=18, width=20, units = "cm")
  # # within edges with significant diagnostic effects. (6)
  # deltaresult.df2 <- deltaresult.df
  # deltaresult.df2$lm.symp.t[!(deltaresult.df2$parcel %in% sigedge.8_10)] <- NA
  # deltaresult.df2$anova.cov.pvalue[!(deltaresult.df2$parcel %in% sigedge.8_10)] <- NA
  # deltaresult.df2$anova.cov.p.fdr <- p.adjust(deltaresult.df2$anova.cov.pvalue, method="fdr")
  # deltaresult.df2$anova.cov.p.fdr[!(deltaresult.df2$parcel %in% sigedge.8_10)] <- 1
  # lmthr <- max(abs(deltaresult.df2$lm.symp.t), na.rm = T)
  # matfig1 <- plotmatrix("deltaresult.df2", "lm.symp.t", Yeoresolution.delLM, Pvar="anova.cov.p.fdr", NAcol="white", lmthr=lmthr, axeslabels=axeslabels, axeslabelsGap=T, linerange_frame=NA, PaletteSet=NA, Pvar.noFDR=NA)
  # ggsave(paste0(FigureFolder, "/DeltaSCDeviation_DeltaSymptom/Matrix_SC_", symptom.tmp, "_DiagnoseEdges_controlSex.tiff"), matfig1, height=18, width=20, units = "cm")
  # 
  # #### Scatter plot
  # if (numsig.fdr2 > 0){
  #   for (i in 1:numsig.fdr2){
  #     deltaresult.df.sigdiag.fdr <- deltaresult.df.sigdiag %>% filter(anova.cov.p.fdr < 0.05)
  #     region <- deltaresult.df.sigdiag.fdr$parcel[i]
  #     
  #     res.df <- lm.fit.symp(region=paste0(region, "_delta"), dataname, symp_var=paste0(symptom.tmp, "_delta"), covariates="sex", if_residual=T)
  #     
  #     
  #     if (str_detect(symptom.tmp, "adhd")){
  #       ytitle <- "ADHD symptom scores"
  #     }else if (str_detect(symptom.tmp, "attention")){
  #       ytitle <- "attention symptom scores"
  #     }else if (str_detect(symptom.tmp, "external")){
  #       ytitle <- "external symptom scores"
  #     }else{ytitle <- symptom.tmp}
  #     
  #     scatterplot <- ggplot(data=res.df)+
  #       geom_point(aes(x=SCDelta.res, y=SymptomDelta.res), color="#810F7C")+
  #       geom_smooth(aes(x=SCDelta.res, y=SymptomDelta.res), fill="#810F7C",color="black", method="lm")+
  #       labs(x="Delta of SC strength deviation", y=paste("Delta of", ytitle))+
  #       theme_classic()+
  #       theme(axis.text=element_text(size=21, color="black"), 
  #             axis.title =element_text(size=21, color="black"),
  #             aspect.ratio = 0.9,
  #             plot.subtitle = element_text(size=20.5, hjust=0.1, vjust=-6, color="black"),
  #             plot.background=element_rect(fill="transparent"),
  #             panel.background=element_rect(fill="transparent"),
  #             legend.text = element_text(size=15, color="black"),
  #             legend.title = element_text(size=15, color="black"))
  #     
  #     ggsave(paste0(FigureFolder, "/DeltaSCDeviation_DeltaSymptom/Scatter/Delta", region, "_Delta", symptom.tmp, "_sigDiagnosis_controlSex.tiff"), scatterplot, width = 13, height=12.8, units = "cm")
  #   }
  # }
  
}

SCcorr.df <- do.call(rbind, SCcorr.df.list)
print(SCcorr.df)

# chord diagram
deltaresult.df.external <- deltacorr[[8]]
deltaresult.df.external$parcel <- gsub("_delta", "", deltaresult.df.external$parcel)
deltaresult.df.external <- deltaresult.df.external %>% mutate(
  correstimate2 = case_when(
    parcel %in% sigedge.8_10 ~ correstimate,
    .default = NA
  )
)

CorrMat <- matrix(NA, Yeoresolution.delLM, Yeoresolution.delLM)
CorrMat[lower.tri(CorrMat, diag=T)] <- deltaresult.df.external$correstimate2
CorrMat[upper.tri(CorrMat)] <- t(CorrMat)[upper.tri(CorrMat)]
delidx.row <- which(rowSums(is.na(CorrMat))==Yeoresolution.delLM)
CorrMat <- CorrMat[-delidx.row, -delidx.row]

Yeo17_SAtab <- read.csv(paste0(resultFolder, '/Yeo17S400_SArank.csv'))
Yeo17_SAtab$index <- c(0:17)
limbicindex <- Yeo17_SAtab$index[str_detect(Yeo17_SAtab$NetworkLabel, "Limbic")]
Yeo17_SAtab <- Yeo17_SAtab %>% filter(! index %in% limbicindex)
Yeo17_SAtab$RGB <- c("white", "#771183", "#FF0200", "#4680B3", "#2ACCA5", "#499C3D", "#007512", "#C334F4", 
                            "#F997D8", "#778CB3", "#E89321", "#8A314B", "#0D28FD", "#000083", "#F9FF04", "#D13F52")

rownames(CorrMat) <- colnames(CorrMat) <- axeslabels[setdiff(1:Yeoresolution.delLM, delidx.row)]
CorrMat[upper.tri(CorrMat)] <- NA
grid.col <- setNames(Yeo17_SAtab$RGB[Yeo17_SAtab$NetworkLabel %in% c("ContC", "SalVentAttnA", "ContA", "SalVentAttnB", "ContB", "DefaultB")], rownames(CorrMat))
col_fun <- colorRamp2(seq(from=min(deltaresult.df.external$correstimate2, na.rm=T), to=max(deltaresult.df.external$correstimate2, na.rm=T), length.out=7), brewer.pal(9, "Purples")[2:8])

CorrMat2 <- CorrMat
CorrMat2[!is.na(CorrMat2)] <- 1

ColMat <- col_fun(CorrMat)

tiff(paste0(FigureFolder, "/DeltaSCDeviation_DeltaSymptom/ChordPlot_Corr.tiff"), width = 12, height = 12, units = "cm", res = 300)
circos.clear()
chordDiagram(x=CorrMat2, grid.col = grid.col, grid.border=NULL, col=ColMat,  transparency = 0.5, directional = 0, self.link=1, link.lwd = 2, annotationTrack = "grid", preAllocateTracks = list(track.height = 0.12), big.gap=T)
circos.trackPlotRegion(track.index = 1, panel.fun = function(x, y) {
  circos.text(
    CELL_META$xcenter,
    CELL_META$ylim[1] + mm_y(2),
    CELL_META$sector.index,
    facing = "outside",
    niceFacing = TRUE,
    cex = 1.5
  )
}, bg.border = NA)
dev.off()

df <- data.frame(x=rep(1, 10), y=c(1:10))
ggplot(data = df)+
  geom_bar(aes(x=1, y=10, fill=y), stat = "identity", position = "stack")+
  scale_fill_gradientn(colors = brewer.pal(9, "Purples")[2:8]) + theme_minimal()



```


## Step3 Multi variates regression

delta_ext ~ delta_SCrank110 + delta_SCrank119 + sex
delta_adhd ~ delta_SCrank119 + sex

```{r}
#| label: Step3
SCdata.ADHDTD.l.delta.l2 <- as.data.frame(SCdata.ADHDTD.l.delta.l2)
SCdata.ADHD.l.delta <- SCdata.ADHDTD.l.delta.l2 %>% filter(if_TD=="ADHD")
SCdata.ADHD.l.delta.b2 <- SCdata.ADHD.l.delta %>% filter(delta_type == "delta_2b")
dataname <- "SCdata.ADHD.l.delta"

## external
MedExternal <- readRDS(paste0(interfileFolder, "/MultiMediation_SCDeviation_cbcl_scr_syn_external_t_Age_CV75_Yeo17_ADHDall_controlSex.rds"))

# 1) Fit models
modExtFormula.full <- as.formula("cbcl_scr_syn_external_t_delta ~ SC.109_delta + SC.119_delta + sex + age.M")
modExtFormula.null <- as.formula("cbcl_scr_syn_external_t_delta ~ sex + age.M")
modExt.full <- glm(modExtFormula.full, family = gaussian, data=SCdata.ADHD.l.delta)
modExt.null <- glm(modExtFormula.null, family = gaussian, data=SCdata.ADHD.l.delta)
summary(modExt.full)

anovaExt <- anovaPB(modExt.null, modExt.full, n.sim = 1000, ncpus=1)
#   Resid. Df Resid. Dev Df Deviance        
# 1       212       3335                    
# 2       210       3232  2    103.1 0.033 *
predictedExt.full <- predict(modExt.full)
predictedExt.null <- predict(modExt.null)

# 2) Partial correlation
pcor_result <- pcor.test(predictedExt.full, SCdata.ADHD.l.delta$cbcl_scr_syn_external_t_delta, predictedExt.null, method = "pearson")
#    estimate     p.value statistic   n gp  Method
# 1 0.1757883 0.009977888  2.600003 215  1 pearson

# 3) plot
predictedExt.full.res <- resid(lm(predictedExt.full ~ predictedExt.null))
actualExt.res <- resid(lm(SCdata.ADHD.l.delta$cbcl_scr_syn_external_t_delta ~ predictedExt.null))

scatterplot <- ggplot()+
  geom_point(aes(x=actualExt.res, y=predictedExt.full.res), color="#810F7C", alpha=0.3)+
  geom_smooth(aes(x=actualExt.res, y=predictedExt.full.res), fill="#810F7C",color="black", method="lm")+
  labs(x="Observed \u0394external symptom", y="Fitted \u0394external symptom")+
  theme_classic()+
  theme(axis.text=element_text(size=21, color="black"),
        axis.title =element_text(size=21, color="black"),
        aspect.ratio = 0.9,
        plot.subtitle = element_text(size=20.5, hjust=0.1, vjust=-6, color="black"),
        plot.background=element_rect(fill="transparent"),
        panel.background=element_rect(fill="transparent"),
        legend.text = element_text(size=15, color="black"),
        legend.title = element_text(size=15, color="black"))

ggsave(paste0(FigureFolder, "/DeltaSCDeviation_DeltaSymptom/Scatter/DeltaSC109SC119_DeltaExternal_Tscore_sigDiagnosis_controlAgeSex.tiff"), scatterplot, width = 13, height=12.8, units = "cm")


## ADHD
MedADHD <- readRDS(paste0(interfileFolder, "/MultiMediation_SCDeviation_cbcl_scr_dsm5_adhd_t_Age_CV75_Yeo17_ADHDall_controlSex.rds"))

# 1) Fit models
modADHDFormula.full <- as.formula("cbcl_scr_dsm5_adhd_t_delta ~ SC.119_delta + sex + age.M")
modADHDFormula.null <- as.formula("cbcl_scr_dsm5_adhd_t_delta ~ sex + age.M")
modADHD.full <- glm(modADHDFormula.full, family = gaussian, data=SCdata.ADHD.l.delta)
modADHD.null <- glm(modADHDFormula.null, family = gaussian, data=SCdata.ADHD.l.delta)
summary(modADHD.full)

anovaADHD <- anovaPB(modADHD.null, modADHD.full, n.sim = 1000, ncpus=1)
#   Resid. Df Resid. Dev Df Deviance        
# 1       212       2492                    
# 2       211       2440  1    51.23 0.038 *
predictedADHD.full <- predict(modADHD.full)
predictedADHD.null <- predict(modADHD.null)

# 2) Partial correlation
pcor_result <- pcor.test(predictedADHD.full, SCdata.ADHD.l.delta$cbcl_scr_dsm5_adhd_t_delta, predictedADHD.null, method = "pearson")
#    estimate     p.value statistic   n gp  Method
# 1  0.143393  0.03606289  2.109635 215  1 pearson

# 3) plot
predictedADHD.full.res <- resid(lm(predictedADHD.full ~ predictedADHD.null))
actualADHD.res <- resid(lm(SCdata.ADHD.l.delta$cbcl_scr_dsm5_adhd_t_delta ~ predictedADHD.null))

scatterplot <- ggplot()+
  geom_point(aes(x=actualADHD.res, y=predictedADHD.full.res), color="#810F7C", alpha=0.3)+
  geom_smooth(aes(x=actualADHD.res, y=predictedADHD.full.res), fill="#810F7C",color="black", method="lm")+
  labs(x="Observed \u0394ADHD symptom", y="Fitted \u0394ADHD symptom")+
  theme_classic()+
  theme(axis.text=element_text(size=21, color="black"),
        axis.title =element_text(size=21, color="black"),
        aspect.ratio = 0.9,
        plot.subtitle = element_text(size=20.5, hjust=0.1, vjust=-6, color="black"),
        plot.background=element_rect(fill="transparent"),
        panel.background=element_rect(fill="transparent"),
        legend.text = element_text(size=15, color="black"),
        legend.title = element_text(size=15, color="black"))

ggsave(paste0(FigureFolder, "/DeltaSCDeviation_DeltaSymptom/Scatter/DeltaSC119_DeltaADHD_Tscore_sigDiagnosis_controlAgeSex.tiff"), scatterplot, width = 13, height=12.8, units = "cm")

p.adjust(c(0.009977888, 0.03606289), method="fdr")
# 0.01995578 0.03606289

```


