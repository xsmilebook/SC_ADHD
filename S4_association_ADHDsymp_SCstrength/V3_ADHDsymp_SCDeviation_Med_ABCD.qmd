---
title: "V3_ADHDsymp_SCDeviation_Med"
author:
  - name: Xiaoyu Xu
    orcid: 0000-0002-7349-3366
    email: xuxiaoyu@cibr.ac.cn
    url: https://scholar.google.com/citations?user=G0jeI1AAAAAJl
    affiliation: 
      - name: Chinese Institute for Brain Research, Beijing (CIBR)
        group: CUIZAIXU Lab
        url: https://cuilab.cibr.ac.cn/
date: "2025-07-03"
format: 
  html:
    code-fold: true
    code-tools: true
    theme: Materia
    toc: true
    toc_depth: 3
    toc-expand: 1
    toc_float: true
    toc-location: left
    number-sections: true
    number-depth: 3
    embed-resources: true
---


```{r}
#| label: load-packages-data
#| include: false

rm(list=ls())
library(mgcv)
library(parallel)
library(tidyverse)
library(psych)
# set resolution
Yeoresolution <- 17
if (Yeoresolution == 7){
  Yeoresolution.delLM = 6
}else if (Yeoresolution == 17){
  Yeoresolution.delLM = 15
}
element_num <- Yeoresolution.delLM*(Yeoresolution.delLM+1)/2
# input directory
wd <- getwd()
homepath <- str_split_i(wd, "Normative_model", 1)
demopath <- paste0(homepath, '/Normative_model/demography')
interfileFolder <- paste0(homepath, '/Normative_model/interfileFolder_ABCD')
functionFolder <- paste0(homepath, "/Normative_model/functions")
resultFolder <- paste0(homepath, "/Normative_model/results_ABCD")
functionFolder.SCDev <- paste0(homepath, "/SC_development/Rcode_SCdevelopment/gamfunction")
FigureFolder <- paste0(homepath, '/Normative_model/Figures_ABCD/Yeo', Yeoresolution,'/CV75')
source(paste0(functionFolder.SCDev, "/SCrankcorr.R"))
#source(paste0(functionFolder, "/linearmediation_longitudinal.R"))
source(paste0(functionFolder, "/parallelmediation.R"))
source(paste0(functionFolder, "/plotmatrix.R"))
# Load data
SCdata.sum75.merge.ADHDTD <- readRDS(paste0(interfileFolder, '/SCdata_Yeo',Yeoresolution, '_CV75_sumSCinvnode.deviations_TDtest_ADHD.rds'))
SCdata.sum75.merge.ADHDTD$sex <- as.factor(SCdata.sum75.merge.ADHDTD$sex)
SCdata.sum75.merge.ADHDTD$meanFD <- as.numeric(SCdata.sum75.merge.ADHDTD$meanFD)
SCdata.sum75.merge.ADHDTD$if_TD <- factor(SCdata.sum75.merge.ADHDTD$if_TD, levels = c("TD", "ADHD"))
SCdata.ADHD <- SCdata.sum75.merge.ADHDTD %>% filter(if_TD=="ADHD")
SCdata.TD <- SCdata.sum75.merge.ADHDTD %>% filter(if_TD=="TD")

Intresults <- readRDS(paste0(interfileFolder, "/Interaction_Age_TD-ADHDall_Yeo_SC", element_num,".rds"))
Int.results.df_final <- Intresults[seq(from=2, to=2*element_num, by = 2),]
Int.results.df_final$bootstrap_pvalue.fdr <- p.adjust(Int.results.df_final$bootstrap_pvalue, method = "fdr")
Int.results.df_final[,3:10] <- lapply(Int.results.df_final[,3:10], as.numeric)
summary(Int.results.df_final)
sigedge.Int <- Int.results.df_final$parcel[Int.results.df_final$bootstrap_pvalue.fdr < 0.05]
sigedge.Int <- gsub("_h", "_deviationZ", sigedge.Int)
diagnosis.rs.8_10 <- readRDS(paste0(interfileFolder, "/GroupcompareDeviation_TD-ADHDall_SC_Yeo", element_num, "_8_10_controlAgeSex.rds"))
sigedge.8_10 <- diagnosis.rs.8_10$parcel[diagnosis.rs.8_10$p.fdr < 0.05]

diffbyage <- read.csv(paste0(resultFolder, "/ADHDTDgroupwise_T_dev_by_age_SC_Yeo", element_num,"_CV75_controlsex.csv"))
sigedge.all <- diffbyage$parcel

DeviationChangeADHD <- read.csv(paste0(resultFolder, "/SCDeviationChange_gamresults_ADHD.csv"))
sigedge.change <- DeviationChangeADHD$parcel[DeviationChangeADHD$bootstrap_p.fdr < 0.05]
#sigedge.change <- unique(sigedge.change, sigedge.Int)

Association_symptom <- read.csv(paste0(resultFolder, "/SCDeviation__Age_CV75_Yeo17_ADHDall_controlAgeSex.csv"))

```


# Step1 Mediation analysis (linear)

Age --> SC Deviation --> Symptoms

```{r}
#| label: Step1

dataname <- "SCdata.ADHD"
symptomvar <- c("cbcl_scr_syn_external_t", "cbcl_scr_dsm5_adhd_t","cbcl_scr_syn_attention_t")
X_var <- "age"

# linear mediation
for (VOI in symptomvar){
  if (!file.exists(paste0(interfileFolder, '/MultiMediation_SCDeviation_', VOI,'_Age_CV75_Yeo', Yeoresolution,'_ADHDall_controlSex.rds'))){
    print(VOI)
    sigedge_symp <- Association_symptom %>% filter(int_var == VOI, bootstrap.P.fdr < 0.05)
    
    mediator <- sigedge_symp$parcel[sigedge_symp$parcel %in% sigedge.change]
    
    resultsum.df <- parallelmediation(mediator, dataname, out_var=VOI, X_var, covariates="sex", boottime=1000, longitudinal=T)
    
    saveRDS(resultsum.df, paste0(interfileFolder, '/MultiMediation_SCDeviation_', VOI,'_Age_CV75_Yeo', Yeoresolution,'_ADHDall_controlSex.rds'))
  }
}


SC_symptom.list <- list()

for (VOI in symptomvar){
  resultsum.df <- readRDS(paste0(interfileFolder, '/MultiMediation_SCDeviation_', VOI,'_Age_CV75_Yeo', Yeoresolution,'_ADHDall_controlSex.rds'))
  SC_symptom.list[[VOI]] <- resultsum.df
  
}

View(SC_symptom.list[["cbcl_scr_dsm5_adhd_t"]]$mediation)
SC_symptom.list[["cbcl_scr_dsm5_adhd_t"]]$mediator

View(SC_symptom.list[["cbcl_scr_syn_attention_t"]]$mediation)
SC_symptom.list[["cbcl_scr_syn_attention_t"]]$mediator

```





